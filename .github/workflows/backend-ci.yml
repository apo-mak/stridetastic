name: Backend CI

on:
  pull_request:
    branches: [ "main", "feat/**", "fix/**" ]
    paths:
      - "api_stridetastic/**"
      - "compose.yaml"
      - "Dockerfile"
      - "**/Dockerfile"
      - ".github/workflows/backend-ci.yml"
  push:
    branches: [ "main" ]
    paths:
      - "api_stridetastic/**"
      - "compose.yaml"
      - "Dockerfile"
      - "**/Dockerfile"
      - ".github/workflows/backend-ci.yml"

permissions:
  contents: read
  pull-requests: read

jobs:
  backend:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres -d postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
    env:
      DB_ENGINE: postgres
      DB_HOST: localhost
      DB_PORT: "5432"
      DB_NAME: postgres
      DB_USER: postgres
      DB_PASSWORD: postgres
    defaults:
      run:
        working-directory: api_stridetastic
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: "api_stridetastic/requirements.txt"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Lint (ruff)
        run: |
          if command -v ruff >/dev/null 2>&1; then
            ruff check .
          else
            pip install ruff
            ruff check .
          fi

      - name: Format check (black)
        run: |
          if command -v black >/dev/null 2>&1; then
            black --check .
          else
            pip install black==25.12.0
            black --check .
          fi

      - name: Import order check (isort)
        run: |
          if command -v isort >/dev/null 2>&1; then
            isort --check-only .
          else
            pip install isort
            isort --check-only .
          fi

      - name: Run tests (pytest)
        run: pytest --disable-warnings -q
